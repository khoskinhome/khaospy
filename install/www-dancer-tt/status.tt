<html>
    <head>

<style>
.nochange {
    background-color: white;
}

.change {
    background-color: red;
}

.controlname {
    background-color: yellow;
}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

<script>

var control_state_value = [];
var control_state_count = [];
var keep_change_count = 45;

// FIXME TODO template toolkit not doing this currently :
// var dancer_base_url = [% DANCER_BASE_URL %];
var dancer_base_url = '/dancer';

$(document).ready(function(){

    function refresh_data(){
        $.get(dancer_base_url + "/api/v1/statusall", function(data, http_status){
            //TODO check the http_status

            for(var i=0;i<data.length;i++){
                var data_row = data[i];
                for(var key in data_row){
                    var control_name    = data_row['control_name'].toString();
                    var new_state_value = data_row['current_state_value'].toString();
                    var old_state_value;

                    if(control_state_value[control_name] === undefined){
                        control_state_count[control_name] = 0;
                        control_state_value[control_name] = new_state_value;
                        old_state_value = new_state_value;
                    } else {
                        old_state_value = control_state_value[control_name];
                    }

                    $("#" + control_name + '-request_time' ).text(data_row['request_time']);
                    $("#" + control_name + '-state_value' ).text(new_state_value);

                    if ( new_state_value != old_state_value ){
                         $("#" + control_name + '-info' ).text("changed");
                         $("#" + control_name + '-state_value' ).addClass("change");
                         control_state_count[control_name] = keep_change_count;
                    } else {

                        if ( control_state_count[control_name] > 0 ){
                            control_state_count[control_name] = control_state_count[control_name] - 1 ;
                        } else {
                            $("#" + control_name + '-info' ).text("");
                            $("#" + control_name + '-state_value' ).removeClass("change");
                        }
                    }

                    console.log(control_name + ' old = ' + old_state_value + ' : new = ' + new_state_value + ' : count = ' + control_state_count[control_name] );
                    control_state_value[control_name] = new_state_value;
                }
            }
        });
    }

    $("button").click(function(){

        var control_name = $(this).attr('id');
        var action       = $(this).attr('value');
        // alert("pressed " + control_name + " " + action );

        $.post(dancer_base_url + "/api/v1/operate/"+control_name+"/"+action,
            { },
            function(data, status){
                // alert("Data: " + data + "\nStatus: " + status);
            }
        );
    });

    setInterval(function(){
        refresh_data()
    }, 1000);


});
</script>

    </head>
    <body>
        <h1>Control Status</h1>
        <table>
          [% FOREACH row IN entries %]
            <tr>
                <td class='controlname' >[% row.control_name %]</td>

                    [% IF row.can_operate %]
                        <td>
                            <button id='[% row.control_name %]' value='on'>On</button>
                        </td>
                        <td>
                            <button id='[% row.control_name %]' value='off'>Off</button>
                        </td>
                    [% ELSE %]
                        <td></td><td></td>
                    [% END %]

                <td id='[% row.control_name %]-state_value'>[% row.current_state_value %]</td>
                <td class='controlname' id='[% row.control_name %]-request_time'>[% row.request_time %]</td>
                <td id='[% row.control_name %]-info'></td>
            </tr>
          [% END %]
        </table>
    </body>
</html>
