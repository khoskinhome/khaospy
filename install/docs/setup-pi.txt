dd image on to micro-sd card.

raspi-config :
    expand the file system
    change user "pi" password
    boot option to console with password
    advanced options
        change hostname
        i2c enable
        ssh-login-enable.

    get the mac-address and add a dhcp config in the tp-link so it will always get the same ip-address.

    copy over the ssh public key, and put in .ssh/authorized_keys

    change visudo to use vim

    /boot/config.txt can need editting to get one-wire working .
    see https://www.raspberrypi.org/forums/viewtopic.php?f=37&t=98407
        http://raspberrypi.stackexchange.com/questions/26623/ds18b20-not-listed-in-sys-bus-w1-devices
    looks like i2c might need dtparam too.
    one wire needs this in the /boot/config.txt :
        dtoverlay=w1-gpio


i2c stuff :
    http://www.raspberrypi-spy.co.uk/2014/11/enabling-the-i2c-interface-on-the-raspberry-pi/
    https://www.raspberrypi.org/forums/viewtopic.php?f=44&t=91762&start=25

    getting i2c-0 working on Pi2 :
        add the kernel parm "bcm2708.vc_i2c_override=1" to /boot/cmdline.txt
        and "dtparam=i2c_vc=on" to /boot/config.txt


/etc/fstab and usb-stick and /opt/khaospy/log
---------------------------------------------
lots of writing of logs will wear out flash cards.
So I guess its better to do this on a usb-memory-stick rather than the main Pi memory-card.

    http://www.raspberrypi-spy.co.uk/2014/05/how-to-mount-a-usb-flash-disk-on-the-raspberry-pi/

    shove in hopefully a small form factor memory stick ( so it doesn't hang out a long way )

    This will usually come up as /dev/sda1 and will be preformatted with vfat.
    I guess you could leave it as vfat, but I'd rather use ext4.


    This will list the attached disks :

    ls -l /dev/disk/by-uuid/




    sudo mkdir /media/usb
    sudo chown -R pi:pi /media/usb

    ext4
    ----
    don't really want vfat , ext4 is the linux FS, so assuming its sda1,
    make sure the drive isn't mounted, make it an ext4 partition,  :

    sudo mkfs.ext4 /dev/sda1 -L media-usb


    this should manually mount it :
        sudo mount /dev/sda1 /media/usb -t ext4


    but its much better to have it auto mounted in the /etc/fstab.

    If it's been reformatted, the uuid would have changed , so :

    ls -l /dev/disk/by-uuid/

    get the uuid , and assuming ext4, then edit the /etc/fstab, and put in the following line :

        if sda1 has been formatted to ext4 :
            UUID=<the-uuid> /media/usb ext4 auto,nofail,noatime,nodiratime,users,rw 0 0


    also needed in the fstab, if DBD::Pg is to be installed ( it uses a lot of /tmp during installation ) :
        tmpfs    /tmp    tmpfs    defaults,noatime,nosuid,size=200m    0 0

    reboot the pi , and make sure the /media/usb mounts with say :

    df -h


    getting the logs written to the /media/usb 

        sudo mkdir /media/usb/khaospy-log
        sudo chown -R pi:pi /media/usb
        sudo chown -R pi:pi /media/usb/khaospy-log/

        cd /opt/khaospy

        sudo rm -rf /opt/khaospy/log

        ln -s /media/usb/khaospy-log/ log

    Logs should now be written to /media/usb .




once fully setup "dd" the micro-sd card and get an image



setup bind9 DNS on piloft

    sudo apt-get install dnsutils bind9-doc bind9

    http://mixeduperic.com/ubuntu/seven-easy-steps-to-setting-up-an-interal-dns-server-on-ubuntu.html

    https://help.ubuntu.com/lts/serverguide/dns-installation.html

      sudo apt-get install bind9
      sudo apt-get update
      sudo apt-get install bind9
      sudo apt-get install dnsutils bind9-doc bind9
      sudo vim /etc/bind/named.conf.options
      sudo vim /etc/bind/named.conf.local
      sudo cp /etc/bind/db.local /etc/bind/db.khaos
      sudo vim /etc/bind/named.conf.local
      sudo vim /etc/bind/db.khaos
      sudo cp /etc/bind/db.127 /etc/bind/db.192
      sudo vim /etc/bind/db.192
      history
      sudo vim /etc/bind/db.192
      sudo /etc/init.d/bind9 start
      sudo vim /etc/resolv.conf
      dig distrowatch.com
      dig karlrad.khaos
      ping karlrad.khaos
      dig distrowatch.com
      ping karlrad.khaos
      dig karlrad.khaos
      ping karlrad
      history



the webserver
##############
    https://www.digitalocean.com/community/tutorials/how-to-create-a-ssl-certificate-on-apache-for-debian-8
    https://www.digitalocean.com/community/tutorials/how-to-create-a-ssl-certificate-on-apache-for-debian-8

# NO DON'T DO THIS :
#    in /etc/apache2/mods-available/ssl.conf change :
#        SSLProtocol all -SSLv3
#            to :
#        SSLProtocol all -TLSv1.2


    I think :
        sudo a2enmod ssl
    does the following ...

    At the command line :
        cd /etc/apache2/mods-enabled
        sudo ln -s ../mods-available/ssl.conf
        sudo ln -s ../mods-available/ssl.load



    https://piserver.khaos/phpldapadmin/cmd.php
    https://www.digitalocean.com/community/tutorials/how-to-set-up-password-authentication-with-apache-on-ubuntu-14-04
    https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-a-basic-ldap-server-on-an-ubuntu-12-04-vps

    symlinks from /var/www/


postgres db.
############

https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-14-04


    https://www.digitalocean.com/community/tutorials/how-to-add-and-delete-users-on-an-ubuntu-14-04-vps
    create unix user names :

    pgread
    pgwrite

        postgres@piserver:~$ createuser --interactive
        Enter name of role to add: khaospy_read
        Shall the new role be a superuser? (y/n) n
        Shall the new role be allowed to create databases? (y/n) n
        Shall the new role be allowed to create more new roles? (y/n) n

        postgres@piserver:~$ createuser --interactive
        Enter name of role to add: khaospy_write
        Shall the new role be a superuser? (y/n) n
        Shall the new role be allowed to create databases? (y/n) n
        Shall the new role be allowed to create more new roles? (y/n) n


    stopped postgres server with

        sudo service postgres stop

    mkdir /media/120GB_ssd/postgres   ( on a usb attached SSD and not on pi main sd card )


    cd /media/120GB_ssd ;  chown postgres.postgres postgres

    cd /var/lib

    mv ./postgres/* /media/120GB_ssd/postgres

    in /etc/postgres/postgresql.conf changed the line to be :
        data_directory = '/media/120GB_ssd/postgresql/9.4/main'         # use data in another directory



sudo crontab -e
################

# make the daemons run on startup , and to keep try running them :
*/1  * * * * /opt/khaospy/bin/khaospy-run-daemons.pl         2>&1  > /dev/null

# keep the logs trimmed down to the last few days :
1 1 * * * find /opt/khaospy/log -type f -mtime +3 -delete 2>&1 > /dev/null


# Not sure about this, might generate rrd's as they're demanded.
# requires a lot of processing :
# */15 * * * * /opt/khaospy/bin/khaospy-generate-rrd-graphs.pl 2>&1  > /dev/null


log-rotate stuff :
##################
there's stuff in my install-to-pi-pi.bash scripts.


TODO Install from a github checkout :
    need to allow a checkout from github on a pi and then ansible up the install.



